```
cacheable: false
```

## Wireshark Lab 7: ICMP

In this lab, we’ll explore several aspects of the ICMP protocol:

* ICMP messages generating by the Ping program
* ICMP messages generated by the Traceroute program
* The format and contents of an ICMP message

Before attacking this lab, you’re encouraged to review the ICMP material in section 5.6 of the book.

### ICMP and Ping

Let’s begin our ICMP adventure by capturing the packets generated by the Ping program. You may recall that the Ping program is simple tool that allows anyone (for example, a network administrator) to verify if a host is live or not. The Ping program in the source host sends a packet to the target IP address; if the target is live, the Ping program in the target host responds by sending a packet back to the source host. As you might have guessed (given that this lab is about ICMP), both of these Ping packets are ICMP packets.

Do the following:

1. Open your terminal (or Windows command prompt)
2. Start up Wireshark and begin a packet capture
3. On Windows, type `ping -n 10 hostname` where `hostname` is a host on another continent. On OS X, substitute `-n` for `-c` to indicate the number of pings to send. For a host, I used the address of my old university, `www.tsuda.ac.jp`, but you may use any host that responds to your pings. 
4. When the Ping program terminates, stop the packet capture in Wireshark.

At the end of the experiment, your terminal should look something like the screenshot below. In this example, the source ping program is in Washington and the destination Ping program is in Japan. From this window we see that the source ping program sent 10 query packets and received 10 responses. Note also that for each response, the source calculates the round-trip time (RTT), which for the 10 packets is on average about 175 msec.

<img src="/~tmullen/images/nw/ws-icmp-ping.png" style="width: 600px;"/>

The screenshot below shows the Wireshark output, after “icmp” has been entered into the filter display window. Note that the packet listing shows 20 packets: the 10 Ping queries sent by the source and the 10 Ping responses received by the source. Also note that the source’s IP address is a private address (behind a NAT) of the form 192.168/12; the destination’s IP address is that of the Web server at Tsuda College. 

<img src="/~tmullen/images/nw/ws-icmp-ping-capture.png" style="width: 600px;"/>

Now let’s zoom in on the first packet (sent by the client); in the figure below, the packet contents area provides information about this packet. We see that the IP datagram within this packet has protocol number 01, which is the protocol number for ICMP. This means that the payload of the IP datagram is an ICMP packet.

<img src="/~tmullen/images/nw/ws-icmp-ping-capture2.png" style="width: 600px;"/>

The screenshot below focuses on the same ICMP but has expanded the ICMP protocol information in the packet contents window. Observe that this ICMP packet is of Type 8 and Code 0 - a so-called ICMP “echo request” packet. (See Figure 5.19 of text.) Also note that this ICMP packet contains a checksum, an identifier, and a sequence number.

<img src="/~tmullen/images/nw/ws-icmp-ping-capture3.png" style="width: 600px;"/>

### What to hand in

You should include a screen shot of the terminal or command prompt window similar to the one above in your pdf.  Answer the following questions and include screenshots of packets corresponding to the answers:

1. What is the IP address of your host? What is the IP address of the destination host?
2. Why is it that an ICMP packet does not have source and destination port numbers?
3. Examine one of the ping request packets sent by your host. What are the ICMP type and code numbers? What other fields does this ICMP packet have? How many bytes are the checksum, sequence number and identifier fields?
4. Examine the corresponding ping reply packet. What are the ICMP type and code numbers? What other fields does this ICMP packet have? How many bytes are the checksum, sequence number and identifier fields?

### ICMP and Traceroute

Let’s now continue our ICMP adventure by capturing the packets generated by the Traceroute program. You may recall that the Traceroute program can be used to figure out the path a packet takes from source to destination. Traceroute is discussed in Section 1.4 and in Section 5.6 of the text.

Traceroute is implemented in different ways in Unix/Linux/MacOS and in Windows. In Unix/Linux, the source sends a series of UDP packets (by default) to the target destination using an unlikely destination port number; in Windows, the source sends a series of ICMP packets to the target destination. For both operating systems, the program sends the first packet with TTL=1, the second packet with TTL=2, and so on. Recall that a router will decrement a packet’s TTL value as the packet passes through the router. When a packet arrives at a router with TTL=1, the router sends an ICMP error packet back to the source. We're interested in the ICMP protocol, so if you're using OS X `traceroute`, you'll add the `-I` option to make it use ICMP instead of UDP. In Windows, the command is `tracert` and can be used with the default. 

Do the following steps:

1. Open the terminal or command prompt. 
2. Start up Wireshark and begin a capture
3. In Windows, type `tracert hostname` where hostname is a host on another continent. I used the University of Edinburgh's server at `www.ed.ac.uk`. On OS X, use the command `traceroute -I hostname`
4. When the Traceroute program terminates, stop packet capture in Wireshark.

At the end of the experiment, your terminal window should look something like the screenshot below. In this figure, the client Traceroute program is in Washington and the target destination is in Scotland. From this figure we see that for each TTL value, the source program sends three probe packets. Traceroute displays the RTTs for each of the probe packets, as well as the IP address (and possibly the name) of the router that returned the ICMP TTL-exceeded message.

<img src="/~tmullen/images/nw/ws-icmp-traceroute.png" style="width: 600px;"/>

The screenshot below displays the Wireshark window for an ICMP packet returned by a router. Note that this ICMP error packet contains many more fields than the Ping ICMP messages.

<img src="/~tmullen/images/nw/ws-icmp-traceroute-capture.png" style="width: 600px;"/>

### What to hand in

Include a screen shot of the terminal window for this part of the lab in the same pdf where you wrote up the Ping questions above. Answer the following questions and include screenshots of packets corresponding to the answers:

5. What is the IP address of your host? What is the IP address of the target destination host?
6. If ICMP sent UDP packets instead (as in Unix/Linux), would the IP protocol number still be 01 for the probe packets? If not, what would it be?
7. Examine the ICMP echo packet in your screenshot. Is this different from the ICMP ping query packets in the first half of this lab? If yes, how so?
8. Examine the ICMP error packet in your screenshot. It has more fields than the ICMP echo packet. What is included in those fields?
9. Examine the last three ICMP packets received by the source host. How are these packets different from the ICMP error packets? Why are they different?
10. Within the Traceroute measurements, is there a link whose delay is significantly longer than others? Refer to the screenshot in Figure 4, is there a link whose delay is significantly longer than others? On the basis of the router names, can you guess the location of the two routers on the end of this link?

### Extra credit

For one of the programming assignments you created a UDP client ping program. This ping program, unlike the standard ping program, sends UDP probe packets rather than ICMP probe packets. Use the client program to send a UDP packet with an unusual destination port number to some live host. At the same time, use Wireshark to capture any response from the target host. Provide aWireshark screenshot for the response as well as an analysis of the response.

## Submission

Create a **pdf** file with the answers to the questions above and the requested screenshots, with the file name  `ws-lab7-<your_name>.pdf` and upload your capture file to the [assignment's Moodle page](https://moodle.pugetsound.edu/moodle/mod/assign/view.php?id=399146).
