```
cacheable: false
```

## Wireshark Lab 3: DNS

As described in Section 2.4 of the text1, the Domain Name System (DNS) translates hostnames to IP addresses, fulfilling a critical role in the Internet infrastructure. In this lab, we’ll take a closer look at the client side of DNS. Recall that the client’s role in the DNS is relatively simple – a client sends a query to its local DNS server, and receives a response back. As shown in Figures 2.19 and 2.20 in the textbook, much can go on “under the covers,” invisible to the DNS clients, as the hierarchical DNS servers communicate with each other to either recursively or iteratively resolve the client’s DNS query. From the DNS client’s standpoint, however, the protocol is quite simple – a query is formulated to the local DNS server and a response is received from that server.

Before beginning this lab, you’ll probably want to review DNS by reading Section 2.4 of the text. In particular, you may want to review the material on local DNS servers, DNS caching, DNS records and messages, and the TYPE field in the DNS record.

# nslookup

In this lab, we’ll make extensive use of the nslookup tool, which is available in most Linux/Unix and Microsoft platforms today. To run nslookup in Linux/Unix, you just type the nslookup command on the command line. To run it in Windows, open the Command Prompt and run nslookup on the command line.

In it is most basic operation, nslookup tool allows the host running the tool to query any specified DNS server for a DNS record. The queried DNS server can be a root DNS server, a top-level-domain DNS server, an authoritative DNS server, or an intermediate DNS server (see the textbook for definitions of these terms). To accomplish this task, nslookup sends a DNS query to the specified DNS server, receives a DNS reply from that same DNS server, and displays the result.

<img src="/~tmullen/images/nw/nslookup1.png " style="width: 600px;"/>

The above screenshot shows the results of two independent nslookup commands (displayed in the OSX Terminal window). In this example, the client host has IP address `207.207.101.4`. If I run

    whois 207.207.101.4

on the command line, I discover that that IP address is associated with:

    OrgName:        University of Puget Sound
    OrgId:          UPS-12
    Address:        1500 N Warner Ave
    City:           Tacoma
    StateProv:      WA
    PostalCode:     98416
    Country:        US
    RegDate:        1991-09-16
    Updated:        2016-05-16

Which is the local DNS server where I'm making the query from (my office on campus). Consider the first command:

    nslookup www.mit.edu

In words, this command is saying “please send me the IP address for the host www.mit.edu”. As shown in the screenshot, the response from this command provides two pieces of information: (1) the name and IP address of the DNS server that provides the answer; and (2) the answer itself, which is the host name and IP address of www.mit.edu. Although the response came from the local DNS server at UPS, it is quite possible that this local DNS server iteratively contacted several other DNS servers to get the answer, as described in Section 2.4 of the textbook.

Now consider the second command:

    nslookup –type=NS mit.edu

In this example, we have provided the option “-type=NS” and the domain “mit.edu”. This causes nslookup to send a query for a type-NS record to the default local DNS server. In words, the query is saying, “please send me the host names of the authoritative DNS for mit.edu”. (When the –type option is not used, nslookup uses the default, which is to query for type A records.) The answer, displayed in the above screenshot, first indicates the DNS server that is providing the answer (which is the default local DNS server) along with three MIT nameservers. Each of these servers is indeed an authoritative DNS server for the hosts on the MIT campus. However, nslookup also indicates that the answer is “non-authoritative,” meaning that this answer came from the cache of some server rather than from an authoritative MIT DNS server. Finally, the answer also includes the IP addresses of the authoritative DNS servers at MIT. (Even though the type-NS query generated by nslookup did not explicitly ask for the IP addresses, the local DNS server returned these “for free” and nslookup displays the result.)

<img src="/~tmullen/images/nw/nslookup2.png " style="width: 600px;"/>

In the screenshot above, I'm calling `nslookup` in two different ways. The first is similar to the first call in the previous screenshot:

    nslookup www.pdza.org

The domain `www.pdza.org` is the website for the [Point Defiance Zoo](http://www.pdza.org/). Once again, this request is being processed by the local default DNS server. However, if I explicitly select a DNS server to query, as in the second command:

    nslookup www.pdza.org dns1.stabletransit.com

The query is sent to that server, which I know is an authoritative provider of the IP address for this domain. (I know this from having run `nslookup -type=NS pdza.org`).

Now that we have gone through a few illustrative examples, you are perhaps wondering about the general syntax of `nslookup` commands. The syntax is:

    nslookup –option1 –option2 host-to-find dns-server

In general, nslookup can be run with zero, one, two or more options. And as we have seen in the above examples, the dns-server is optional as well; if it is not supplied, the query is sent to the default local DNS server.

Now that we have provided an overview of nslookup, it is time for you to test drive it yourself. Do the following (and write down the results):

1. Run nslookup to obtain the IP address of a Web server in Asia. What is the IP address of that server?
2. Run nslookup to determine the authoritative DNS servers for a university in Europe.
3. Run nslookup so that one of the DNS servers obtained in Question 2 is queried for the mail servers for Yahoo! mail. What is its IP address?

## ipconfig

`ipconfig` (for Windows) and `ifconfig` (for Linux/Unix) are among the most useful little utilities in your host, especially for debugging network issues. I use `ifconfig` on OS X, but `ipconfig` is very similar. `ipconfig` can be used to show your current TCP/IP information, including your address, DNS server addresses, adapter type and so on. For example, if you all this information about your host simply by entering

    ipconfig \\all

or in OSX

    ifconfig

which outputs something like the following screenshot:

<img src="/~tmullen/images/nw/ifconfig1.png " style="width: 600px;"/>

`ipconfig` (Windows) is also very useful for managing the DNS information stored in your host. In Section 2.5 we learned that a host can cache DNS records it recently obtained. To see these cached records, after the prompt C:\> provide the following command:

    ipconfig /displaydns

In OS X, it's a little more complicated. First you need to send a SIGINFO signal to mDNSResponder, which causes it to dump a summary of the DNS cache to `/var/log/system.log`:

    sudo killall -INFO mDNSResponder

Then you can see the results by `grep`-ing the `mDNSResponder` string in the contents of that file:

    grep mDNSResponder /var/log/system.log

To clear the cache in Windows, enter

    ipconfig /flushdns

and in OS X:

    sudo killall -HUP mDNSResponder

Flushing the DNS cache clears all entries and reloads the entries from the hosts file.

## Tracing DNS with Wireshark

Now that we are familiar with `nslookup` and `ipconfig`, we’re ready to get down to some serious business. Let’s first capture the DNS packets that are generated by ordinary Web- surfing activity.

* Use `ipconfig` or sudo `killall -HUP mDNSResponder` to empty the DNS cache in your host.
* Open your browser and empty your browser cache. I recommend using Firefox for this, and clearing the cache by refreshing a different page using ctrl-shift-R (or cmd-shift-R on OS X).
* Open Wireshark and enter `“ip.addr == your_IP_address”` into the filter, where
you obtain `your_IP_address` with `ipconfig` or `ifconfig`. This filter removes all packets that
neither originate nor are destined to your host.
* Start packet capture in Wireshark.
* With your browser, visit the Web page: http://www.ietf.org
* Stop packet capture.

Answer the following questions. Whenever possible, when answering a question below, you should turn in a file with screenshots of the of the packet(s) within the trace that you used to answer the question asked. Annotate the file to explain your answer.

4. Locate the DNS query and response messages. Are then sent over UDP or TCP?
5. What is the destination port for the DNS query message? What is the source port
of DNS response message?
6. To what IP address is the DNS query message sent? Use `ipconfig` or `sudo killall -INFO mDNSResponder` and `grep mDNSResponder /var/log/system.log` to determine the
IP address of your local DNS server. Are these two IP addresses the same? Are they the same as the server listed in your nslookup query?
7. Examine the DNS query message. What “Type” of DNS query is it? Does the
query message contain any “answers”?
8. Examine the DNS response message. How many “answers” are provided? What
do each of these answers contain?
9. Consider the subsequent TCP SYN packet sent by your host. Does the destination IP address of the SYN packet correspond to any of the IP addresses provided in the DNS response message?
10. This web page contains images. Before retrieving each image, does your host issue new DNS queries?

Now let's play with *nslookup*.

* Start packet capture.
* Do an nslookup on www.mit.edu
* Stop packet capture.

You should get a trace that looks something like the following:

<img src="/~tmullen/images/nw/wiresharkdns.png " style="width: 600px;"/>

You may find that that nslookup actually sent three DNS queries and received three DNS responses. For the purpose of this assignment, in answering the following questions, ignore the first two sets of queries/responses (if there are more), as they are specific to nslookup and are not normally generated by standard Internet applications. You should instead focus on the last query and response messages (the only two shown above).

11. What is the destination port for the DNS query message? What is the source port of DNS response message?
12. To what IP address is the DNS query message sent? Is this the IP address of your default local DNS server?
13. Examine the DNS query message. What “Type” of DNS query is it? Does the query message contain any “answers”?
14. Examine the DNS response message. How many “answers” are provided? What do each of these answers contain?
15. Provide a screenshot.


Now repeat the previous experiment, but instead issue the command:

    nslookup –type=NS mit.edu

Answer the following questions:

16. To what IP address is the DNS query message sent? Is this the IP address of your default local DNS server?
17. Examine the DNS query message. What “Type” of DNS query is it? Does the query message contain any “answers”?
18. Examine the DNS response message. What MIT nameservers does the response message provide? Does this response message also provide the IP addresses of the MIT namesers?
19. Provide a screenshot.

Now repeat the previous experiment, but instead issue the command:

    nslookup www.pdza.org dns1.stabletransit.com

Answer the following questions:

20. To what IP address is the DNS query message sent? Is this the IP address of your default local DNS server? If not, what does the IP address correspond to?
21. Examine the DNS query message. What “Type” of DNS query is it? Does the query message contain any “answers”?
22. Examine the DNS response message. How many “answers” are provided? What does each of these answers contain?
23. Provide a screenshot.

## Submission

Create a **pdf** file with the answers to the questions above, including all necessary screenshots, with the file name  `ws-lab3-<your_name>.pdf` and upload your capture file to the [assignment's Moodle page](https://moodle.pugetsound.edu/moodle/mod/assign/view.php?id=390685).
